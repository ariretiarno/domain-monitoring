# Implementation Plan

- [x] 1. Set up project structure and dependencies
  - Initialize Go module with `go mod init`
  - Create directory structure: `cmd/`, `internal/domain/`, `internal/repository/`, `internal/whois/`, `internal/scheduler/`, `internal/alert/`, `internal/web/`
  - Add dependencies: `github.com/mattn/go-sqlite3`, `github.com/jmoiron/sqlx`, `github.com/likexian/whois`, `github.com/likexian/whois-parser`, `github.com/leanovate/gopter`
  - Create main.go entry point in `cmd/dem/`
  - _Requirements: All_

- [x] 2. Implement domain models and core types
  - [x] 2.1 Create domain model structs
    - Define `Domain`, `Config`, `Alert`, and `DomainInfo` structs in `internal/domain/`
    - Add JSON and database tags to all fields
    - Implement helper methods for date calculations (DaysUntilExpiration, IsExpired)
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 3.7_
  - [x] 2.2 Write property test for configuration persistence
    - **Property 3: Configuration persistence**
    - **Validates: Requirements 2.2, 6.3, 7.3**

- [x] 3. Implement database layer with SQLite
  - [x] 3.1 Create database schema and migrations
    - Write SQL schema for domains, config, and alerts tables
    - Implement migration system to create tables on first run
    - Add indexes on domain name and expiration_date columns
    - _Requirements: 10.1, 10.5_
  - [x] 3.2 Implement DomainRepository interface
    - Create `repository/domain.go` with CRUD operations
    - Implement `Create`, `GetByID`, `GetAll`, `Update`, `Delete`, `DeleteOlderThan` methods
    - Use prepared statements and transactions where appropriate
    - _Requirements: 4.1, 4.3, 8.2, 8.3, 10.1_
  - [x] 3.3 Implement ConfigRepository interface
    - Create `repository/config.go` with Get and Update methods
    - Handle default configuration values on first access
    - _Requirements: 2.1, 2.2, 6.1, 7.2, 8.5_
  - [x] 3.4 Implement AlertRepository interface
    - Create `repository/alert.go` with Create, GetByDomainID, and HasAlertBeenSent methods
    - Implement query to check for duplicate alerts
    - _Requirements: 6.4, 6.5_
  - [x] 3.5 Write property test for domain addition and retrieval
    - **Property 6: Domain addition and retrieval**
    - **Validates: Requirements 4.1, 4.2**
  - [x] 3.6 Write property test for startup domain loading
    - **Property 17: Startup domain loading**
    - **Validates: Requirements 10.1**
  - [x] 3.7 Write property test for graceful shutdown persistence
    - **Property 20: Graceful shutdown persistence**
    - **Validates: Requirements 10.5**

- [x] 4. Implement WHOIS service
  - [x] 4.1 Create WHOIS query functionality
    - Implement `whois/service.go` with QueryDomain method
    - Use `likexian/whois` library for WHOIS queries
    - Add timeout handling (30 seconds default)
    - Implement retry logic with exponential backoff
    - _Requirements: 1.1, 1.5_
  - [x] 4.2 Implement WHOIS response parsing
    - Use `likexian/whois-parser` to extract domain information
    - Parse expiration date, nameservers, registrant, and registrar
    - Handle parsing errors gracefully with detailed logging
    - _Requirements: 1.2, 1.3, 1.4, 9.2_
  - [x] 4.3 Write property test for complete WHOIS data extraction
    - **Property 1: Complete WHOIS data extraction**
    - **Validates: Requirements 1.1, 1.2, 1.3, 1.4**
  - [x] 4.4 Write unit tests for WHOIS error handling
    - Test timeout handling and retry logic
    - Test parsing error handling with malformed responses
    - _Requirements: 1.5, 9.1, 9.2_

- [x] 5. Implement alert service
  - [x] 5.1 Create alert evaluation logic
    - Implement `alert/service.go` with EvaluateAlerts method
    - Compare domain expiration date against all configured thresholds
    - Check AlertRepository to prevent duplicate alerts
    - Generate Alert objects for crossed thresholds
    - _Requirements: 5.1, 6.4, 6.5, 10.4_
  - [x] 5.2 Implement Google Chat webhook integration
    - Implement SendAlert method with HTTP POST to webhook URL
    - Format alert messages using Google Chat card format
    - Include domain name, expiration date, and days remaining
    - Add retry logic with exponential backoff (max 3 retries)
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  - [x] 5.3 Add alert message formatting
    - Create FormatAlertMessage function
    - Generate human-readable messages with all required information
    - Handle missing webhook URL gracefully (log only)
    - _Requirements: 5.2, 5.3, 5.4, 7.4_
  - [x] 5.4 Write property test for alert threshold triggering
    - **Property 8: Alert threshold triggering**
    - **Validates: Requirements 5.1**
  - [x] 5.5 Write property test for alert message completeness
    - **Property 9: Alert message completeness**
    - **Validates: Requirements 5.2, 5.3, 5.4**
  - [x] 5.6 Write property test for alert deduplication
    - **Property 10: Alert deduplication**
    - **Validates: Requirements 6.4, 6.5**

- [x] 6. Implement scheduler for periodic monitoring
  - [x] 6.1 Create scheduler service
    - Implement `scheduler/scheduler.go` with Start, Stop, ScheduleDomain, UnscheduleDomain methods
    - Use goroutines and time.Ticker for periodic execution
    - Implement worker pool pattern to limit concurrent WHOIS queries (10 workers)
    - Track next check time for each domain
    - _Requirements: 2.4, 10.2, 10.3_
  - [x] 6.2 Integrate scheduler with WHOIS and alert services
    - On each scheduled check, call WHOIS service to query domain
    - Update domain record in repository with new WHOIS data
    - Call alert service to evaluate thresholds after each query
    - Reschedule next check based on monitoring interval
    - _Requirements: 2.4, 10.3, 10.4_
  - [x] 6.3 Implement graceful shutdown for scheduler
    - Handle context cancellation to stop all workers
    - Wait for in-flight WHOIS queries to complete (with timeout)
    - Persist current state before shutdown
    - _Requirements: 10.5_
  - [x] 6.4 Write property test for scheduler initialization
    - **Property 18: Scheduler initialization**
    - **Validates: Requirements 10.2**
  - [x] 6.5 Write property test for alert evaluation after query
    - **Property 19: Alert evaluation after query**
    - **Validates: Requirements 10.4**

- [x] 7. Implement web UI - HTTP server and routing
  - [x] 7.1 Set up HTTP server and router
    - Create `web/server.go` with HTTP server setup
    - Use `net/http` with custom ServeMux or chi router
    - Define routes for dashboard, domain management, and configuration
    - Add middleware for logging and error handling
    - _Requirements: 3.1_
  - [x] 7.2 Implement health check endpoint
    - Create GET /health endpoint that returns 200 OK
    - Include database connectivity check
    - _Requirements: 3.1_
  - [x] 7.3 Write unit test for web UI accessibility
    - Test that HTTP server starts and responds to requests
    - _Requirements: 3.1_

- [ ] 8. Implement web UI - domain management handlers
  - [ ] 8.1 Create domain list handler
    - Implement GET / handler to display all monitored domains
    - Fetch all domains from repository
    - Render HTML template with domain list
    - Include expiration date, days remaining, and status for each domain
    - _Requirements: 3.2, 3.3, 3.7_
  - [ ] 8.2 Create domain detail handler
    - Implement GET /domains/:id handler
    - Fetch domain by ID from repository
    - Render HTML template with complete domain information
    - Display nameservers, registrant, registrar, and all WHOIS data
    - _Requirements: 3.3, 3.4, 3.5, 3.6, 3.7_
  - [ ] 8.3 Create add domain handler
    - Implement POST /domains handler
    - Validate domain name format
    - Perform immediate WHOIS query for validation
    - Add domain to repository and scheduler
    - Return success response or error
    - _Requirements: 4.1, 4.2_
  - [ ] 8.4 Create delete domain handler
    - Implement DELETE /domains/:id handler
    - Remove domain from scheduler
    - Mark domain as inactive in repository (soft delete)
    - Return success response
    - _Requirements: 4.3, 4.4_
  - [ ] 8.5 Write property test for domain list completeness
    - **Property 5: Domain list completeness**
    - **Validates: Requirements 3.2**
  - [ ] 8.6 Write property test for domain display completeness
    - **Property 4: Domain display completeness**
    - **Validates: Requirements 3.3, 3.4, 3.5, 3.6, 3.7**
  - [ ] 8.7 Write property test for domain removal stops monitoring
    - **Property 7: Domain removal stops monitoring**
    - **Validates: Requirements 4.3**

- [ ] 9. Implement web UI - configuration handlers
  - [ ] 9.1 Create configuration view handler
    - Implement GET /config handler
    - Fetch current configuration from repository
    - Render HTML template with configuration form
    - Display monitoring interval, alert thresholds, webhook URL, and retention period
    - _Requirements: 2.1, 6.1, 7.2, 8.5_
  - [ ] 9.2 Create configuration update handler
    - Implement POST /config handler
    - Validate monitoring interval (>= 1 hour)
    - Validate alert thresholds (all positive durations)
    - Validate webhook URL (HTTPS only)
    - Validate retention period (>= 1 day)
    - Update configuration in repository
    - Apply new settings to scheduler and alert service
    - _Requirements: 2.2, 2.3, 6.2, 6.3, 7.1, 7.3, 8.1, 8.2_
  - [ ] 9.3 Write property test for monitoring interval validation
    - **Property 2: Monitoring interval validation**
    - **Validates: Requirements 2.3**
  - [ ] 9.4 Write property test for alert threshold validation
    - **Property 11: Alert threshold validation**
    - **Validates: Requirements 6.2**
  - [ ] 9.5 Write property test for webhook URL validation
    - **Property 12: Webhook URL validation**
    - **Validates: Requirements 7.1**
  - [ ] 9.6 Write property test for retention period validation
    - **Property 13: Retention period validation**
    - **Validates: Requirements 8.1**

- [ ] 10. Implement web UI - HTML templates
  - [ ] 10.1 Create base template layout
    - Create `web/templates/base.html` with common HTML structure
    - Include CSS for clean, responsive design
    - Add navigation menu
    - _Requirements: 3.1_
  - [ ] 10.2 Create dashboard template
    - Create `web/templates/dashboard.html`
    - Display domain list in table format
    - Show domain name, expiration date, days remaining, status
    - Add buttons for adding new domain and viewing details
    - Use color coding for expiration urgency (red < 30 days, yellow < 90 days, green > 90 days)
    - _Requirements: 3.2, 3.3, 3.7_
  - [ ] 10.3 Create domain detail template
    - Create `web/templates/domain.html`
    - Display all domain information in organized sections
    - Show WHOIS data, alert history, and monitoring status
    - _Requirements: 3.3, 3.4, 3.5, 3.6, 3.7_
  - [ ] 10.4 Create configuration template
    - Create `web/templates/config.html`
    - Build form for all configuration settings
    - Add input validation and help text
    - _Requirements: 2.2, 6.3, 7.1, 8.1_

- [ ] 11. Implement retention policy cleanup
  - [ ] 11.1 Create retention cleanup service
    - Implement periodic cleanup job that runs daily
    - Query for historical records older than retention period
    - Exclude actively monitored domains from deletion
    - Delete expired records from database
    - Log cleanup statistics
    - _Requirements: 8.2, 8.3, 8.4_
  - [ ] 11.2 Write property test for retention policy application
    - **Property 14: Retention policy application**
    - **Validates: Requirements 8.2, 8.3**
  - [ ] 11.3 Write property test for active domain preservation
    - **Property 15: Active domain preservation**
    - **Validates: Requirements 8.4**

- [ ] 12. Implement error handling and logging
  - [ ] 12.1 Add structured logging
    - Set up logging framework (use standard library or zerolog)
    - Add log statements for all major operations
    - Include context (domain name, operation type) in logs
    - Log errors with stack traces
    - _Requirements: 1.5, 5.5, 7.4, 9.1, 9.2, 9.5_
  - [ ] 12.2 Implement error response handling
    - Create error response helper functions
    - Return appropriate HTTP status codes (400, 404, 500)
    - Include error messages in response body
    - _Requirements: 9.4_
  - [ ] 12.3 Add database error handling
    - Implement connection retry logic with exponential backoff
    - Handle constraint violations gracefully
    - Wrap operations in transactions where needed
    - _Requirements: 9.3_
  - [ ] 12.4 Write property test for HTTP error responses
    - **Property 16: HTTP error responses**
    - **Validates: Requirements 9.4**

- [x] 13. Wire everything together in main application
  - [x] 13.1 Create application initialization
    - Initialize database connection and run migrations
    - Load configuration from repository (create defaults if not exists)
    - Initialize all services (WHOIS, Alert, Scheduler)
    - Load all domains and schedule monitoring
    - _Requirements: 10.1, 10.2_
  - [x] 13.2 Start HTTP server and scheduler
    - Start scheduler in background goroutine
    - Start HTTP server on configured port (default 8080)
    - Handle OS signals for graceful shutdown
    - _Requirements: 3.1, 10.3_
  - [x] 13.3 Implement graceful shutdown
    - Listen for SIGINT and SIGTERM signals
    - Stop accepting new HTTP requests
    - Stop scheduler and wait for in-flight operations
    - Persist all state to database
    - Close database connections
    - _Requirements: 10.5_

- [ ] 14. Add configuration file and environment variable support
  - [ ] 14.1 Create configuration file parser
    - Support YAML configuration file for non-sensitive settings
    - Define configuration structure (database path, HTTP port, log level)
    - Load configuration from file on startup
    - _Requirements: All_
  - [ ] 14.2 Add environment variable overrides
    - Support environment variables for sensitive data (webhook URL)
    - Override file configuration with environment variables
    - Document all configuration options in README
    - _Requirements: 7.2_

- [ ] 15. Create README and documentation
  - [ ] 15.1 Write README with setup instructions
    - Document installation steps
    - Explain configuration options
    - Provide usage examples
    - Include screenshots of web UI
    - _Requirements: All_
  - [ ] 15.2 Add API documentation
    - Document all HTTP endpoints
    - Include request/response examples
    - Explain error codes
    - _Requirements: 3.1, 4.1, 4.3_

- [ ] 16. Final checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
